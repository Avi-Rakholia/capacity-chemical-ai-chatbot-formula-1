<div class="chatbot-container">
  
  <!-- Three dots menu -->
  <div class="actions-menu">
    <button class="menu-btn" (click)="toggleMenu()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <circle cx="9" cy="3" r="1.5" fill="#333"/>
        <circle cx="9" cy="9" r="1.5" fill="#333"/>
        <circle cx="9" cy="15" r="1.5" fill="#333"/>
      </svg>
    </button>

    <div class="dropdown" *ngIf="menuOpen()">
      <div class="dropdown-item" (click)="handleNewChat()">
        <span class="item-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M2 8h12M8 2v12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </span>
        New Chat
      </div>

      <div class="dropdown-item" (click)="handleSearch()">
        <span class="item-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="7" cy="7" r="5" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M11 11l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </span>
        Search
      </div>

      <div class="dropdown-item" (click)="handleHistory()">
        <span class="item-icon">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M8 4v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </span>
        History
      </div>
    </div>
  </div>

  
  <!-- MAIN WRAPPER -->
  <div class="wrapper">

    <!-- Logo - Show only when templates are visible -->
    <div class="logo" *ngIf="showTemplates()"></div>

    <!-- Heading - Show only when templates are visible -->
    <h1 class="header-text" *ngIf="showTemplates()">How can we assist you today?</h1>

    <p class="subtext" *ngIf="showTemplates()">
      Start by searching a new formula, and let the bot do the tedious work.<br>
      Not sure where to start?
    </p>

    <!-- Card Row - Show only when templates are visible -->
    <div class="card-row" *ngIf="showTemplates()">

      <div class="card" (click)="onSearchFormula()">
        <div class="card-content">
          <div class="card-header">Search<br />Formula</div>
          <div class="arrow-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="#333" stroke-width="1.5"/>
              <path d="M10 8l4 4-4 4" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        <p class="card-sub-text">Search formula from our formula database...</p>
      </div>

      <div class="card" (click)="onCreateFormula()">
        <div class="card-content">
          <div class="card-header">Create<br />Formula</div>
          <div class="arrow-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="#333" stroke-width="1.5"/>
              <path d="M10 8l4 4-4 4" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        <p class="card-sub-text">Search formula from our formula database...</p>
      </div>

      <div class="card" (click)="onGenerateQuote()">
        <div class="card-content">
          <div class="card-header">Generate<br />Quote</div>
          <div class="arrow-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
              <circle cx="12" cy="12" r="10" stroke="#333" stroke-width="1.5"/>
              <path d="M10 8l4 4-4 4" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </div>
        <p class="card-sub-text">Search formula from our formula database...</p>
      </div>

    </div>


    <!-- Chat Window - Show after first message -->
    <div
  class="chat-window"
  *ngIf="!showTemplates() && messages().length > 0"
  #chatWindow
>

      <div *ngFor="let msg of messages(); let i = index" [class]="msg.isUser ? 'chat-bubble user' : 'chat-bubble ai'">
        
        <!-- User message -->
        <div *ngIf="msg.isUser" class="message-content">
          <div class="message-text">{{ msg.prompt }}</div>
          
          <!-- Show attachments if any -->
          <div *ngIf="msg.attachments && msg.attachments.length > 0" class="attachments">
            <div *ngFor="let att of msg.attachments" class="attachment-item">
              <span class="attachment-icon">üìé</span>
              <span class="attachment-name">{{ att.file_name }}</span>
            </div>
          </div>
        </div>

        <!-- AI message -->
        <div *ngIf="!msg.isUser" class="ai-message-wrapper">

  <!-- AI bubble -->
  <div class="message-content">
    <div #messageContent class="message-text markdown-content" [innerHTML]="msg.response | markdown">
      <span *ngIf="msg.isStreaming" class="streaming-cursor">‚ñä</span>
    </div>

    <!-- Questionnaire input if question type is provided -->
    <app-questionnaire-input 
      *ngIf="msg.questionType && msg.awaitingAnswer && !msg.isStreaming"
      [questionType]="msg.questionType"
      [options]="msg.questionOptions || []"
      (answerSubmitted)="handleQuestionnaireAnswer($event, i)"
    />
  </div>

  <!-- AI actions (outside bubble) -->
  <div class="ai-actions" *ngIf="!msg.awaitingAnswer">
    <button type="button" title="Copy" (click)="copyMessageWithFormatting(messageContent)">
      <img src="/assets/copy.svg" alt="Copy" />
    </button>

    <button type="button" title="Share" (click)="shareMessage(msg.response)">
      <img src="/assets/share.svg" alt="Share" />
    </button>
  </div>

</div>

      </div>
    </div>


    <!-- Attachment Preview Area -->
    <div class="attachment-preview" *ngIf="!showTemplates() && getTotalSelectedCount() > 0">
      <div class="attachment-count">
        <span class="count-badge">{{ getTotalSelectedCount() }}</span>
        <span class="count-label">attachment{{ getTotalSelectedCount() > 1 ? 's' : '' }} selected</span>
        <button type="button" class="clear-all-btn" (click)="clearAllSelections()" title="Clear all attachments">‚úï</button>
      </div>
      
      <div class="attachment-list">
        @for (file of selectedFiles(); track file.name) {
          <div class="attachment-chip file">
            <span class="chip-icon">üìé</span>
            <span class="chip-text">{{ file.name }}</span>
            <button type="button" class="chip-remove" (click)="removeFile(file)">√ó</button>
          </div>
        }
        @for (resource of selectedResources(); track resource.resource_id) {
          <div class="attachment-chip resource">
            <span class="chip-icon">üîó</span>
            <span class="chip-text">{{ resource.file_name }}</span>
            <button type="button" class="chip-remove" (click)="removeResource(resource)">√ó</button>
          </div>
        }
        @for (quote of selectedQuotes(); track quote.id) {
          <div class="attachment-chip quote">
            <span class="chip-icon">üí¨</span>
            <span class="chip-text">{{ quote.title || quote.name }}</span>
            <button type="button" class="chip-remove" (click)="toggleQuoteSelection(quote)">√ó</button>
          </div>
        }
        @for (kb of selectedKnowledgeBase(); track kb.id) {
          <div class="attachment-chip knowledge">
            <span class="chip-icon">üìö</span>
            <span class="chip-text">{{ kb.title || kb.name }}</span>
            <button type="button" class="chip-remove" (click)="toggleKnowledgeBaseSelection(kb)">√ó</button>
          </div>
        }
        @for (template of selectedTemplates(); track template.template_id) {
          <div class="attachment-chip template">
            <span class="chip-icon">üìã</span>
            <span class="chip-text">{{ template.title }}</span>
            <button type="button" class="chip-remove" (click)="toggleTemplateSelection(template)">√ó</button>
          </div>
        }
      </div>
    </div>

    <!-- Input Area -->
    <div class="input-bar" >
      <input 
        type="text" 
        placeholder="Type your query here..." 
        [value]="userMessage()"
        (input)="userMessage.set($any($event.target).value)"
        (keyup.enter)="sendMessage()"
        [disabled]="isStreaming()"
        #chatInput
      />

      <!-- Attach Document Button -->
      <button class="attach-btn" (click)="toggleAttachmentModal()" [disabled]="isStreaming()">
        <img src="/assets/attach-document.svg" class="attach-icon" alt="Attach" />
      </button>

      <!-- Hidden File Input -->
      <input 
        type="file" 
        #fileInput
        (change)="onFileSelected($event)"
        accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
        style="display:none"
        multiple
      />

      <!-- Send Button -->
      <button class="send-btn" (click)="sendMessage()" [disabled]="isStreaming() || !userMessage().trim()">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M2 10l16-8-8 16-2-8-6-0z" fill="currentColor"/>
        </svg>
      </button>

    </div>

  </div>

</div>

<!-- Attachment Modal -->
<div *ngIf="showAttachmentModal()" class="modal-overlay" (click)="closeAttachmentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Add Attachments</h3>
      <button type="button" class="close-btn" (click)="closeAttachmentModal()">√ó</button>
    </div>
    
    <div class="modal-body">
      <div class="attachment-tabs">
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab() === 'knowledgeBase'"
          (click)="activeTab.set('knowledgeBase')">
          Knowledge Base
        </button>
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab() === 'quotes'"
          (click)="activeTab.set('quotes')">
          Quotes
        </button>
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab() === 'templates'"
          (click)="activeTab.set('templates')">
          Templates
        </button>
        <button 
          type="button" 
          class="tab-btn" 
          [class.active]="activeTab() === 'files'"
          (click)="activeTab.set('files')">
          Files
        </button>
      </div>
      
      <div class="tab-content">
        <!-- Knowledge Base Tab -->
        <div *ngIf="activeTab() === 'knowledgeBase'" class="tab-panel">
          <div class="items-list">
            @if (availableKnowledgeBase().length === 0) {
              <div class="no-items">No knowledge base items available</div>
            } @else {
              @for (kb of availableKnowledgeBase(); track kb.id) {
                <div 
                  class="item-row" 
                  [class.selected]="selectedKnowledgeBase().includes(kb)"
                  (click)="toggleKnowledgeBaseSelection(kb)">
                  <div class="item-icon">üìö</div>
                  <div class="item-info">
                    <div class="item-title">{{ kb.title || kb.name }}</div>
                    <div class="item-description">{{ kb.description || 'Knowledge base item' }}</div>
                  </div>
                  <div class="item-checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="selectedKnowledgeBase().includes(kb)"
                      (click)="$event.stopPropagation()"
                      (change)="toggleKnowledgeBaseSelection(kb)">
                  </div>
                </div>
              }
            }
          </div>
        </div>
        
        <!-- Quotes Tab -->
        <div *ngIf="activeTab() === 'quotes'" class="tab-panel">
          <div class="items-list">
            @if (availableQuotes().length === 0) {
              <div class="no-items">No quotes available</div>
            } @else {
              @for (quote of availableQuotes(); track quote.id) {
                <div 
                  class="item-row" 
                  [class.selected]="selectedQuotes().includes(quote)"
                  (click)="toggleQuoteSelection(quote)">
                  <div class="item-icon">üí¨</div>
                  <div class="item-info">
                    <div class="item-title">{{ quote.title || quote.name }}</div>
                    <div class="item-description">{{ quote.description || 'Quote item' }}</div>
                  </div>
                  <div class="item-checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="selectedQuotes().includes(quote)"
                      (click)="$event.stopPropagation()"
                      (change)="toggleQuoteSelection(quote)">
                  </div>
                </div>
              }
            }
          </div>
        </div>
        
        <!-- Templates Tab -->
        <div *ngIf="activeTab() === 'templates'" class="tab-panel">
          <div class="items-list">
            @if (availableTemplates().length === 0) {
              <div class="no-items">No templates available</div>
            } @else {
              @for (template of availableTemplates(); track template.template_id) {
                <div 
                  class="item-row" 
                  [class.selected]="selectedTemplates().includes(template)"
                  (click)="toggleTemplateSelection(template)">
                  <div class="item-icon">üìã</div>
                  <div class="item-info">
                    <div class="item-title">{{ template.title }}</div>
                    <div class="item-description">{{ template.description || 'Template item' }}</div>
                  </div>
                  <div class="item-checkbox">
                    <input 
                      type="checkbox" 
                      [checked]="selectedTemplates().includes(template)"
                      (click)="$event.stopPropagation()"
                      (change)="toggleTemplateSelection(template)">
                  </div>
                </div>
              }
            }
          </div>
        </div>
        
        <!-- Files Tab -->
        <div *ngIf="activeTab() === 'files'" class="tab-panel">
          <div class="file-upload-area" (click)="triggerFileInput()" (dragover)="onDragOver($event)" (drop)="onFileDrop($event)">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">
              <p>Click to select files or drag and drop</p>
              <p class="upload-subtext">PDF, DOC, XLS, PNG, JPG supported</p>
            </div>
          </div>
          
          @if (selectedFiles().length > 0) {
            <div class="selected-files">
              <h4>Selected Files:</h4>
              @for (file of selectedFiles(); track file.name) {
                <div class="file-item">
                  <span class="file-icon">üìé</span>
                  <span class="file-name">{{ file.name }}</span>
                  <span class="file-size">({{ formatFileSize(file.size) }})</span>
                  <button type="button" class="remove-file-btn" (click)="removeFile(file)">√ó</button>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>


    
    <div class="modal-footer">
      <button type="button" class="cancel-btn" (click)="closeAttachmentModal()">Cancel</button>
      <button type="button" class="attach-selected-btn" (click)="closeAttachmentModal()">
        Attach Selected ({{ getTotalSelectedCount() }})
      </button>
    </div>
  </div>
</div>
        <!-- History Modal -->
        <div *ngIf="showHistory()" class="modal-overlay" (click)="closeHistory()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="modal-header">
              <h3>Chat History</h3>
              <button type="button" class="close-btn" (click)="closeHistory()">√ó</button>
            </div>
            <div class="modal-body">
              <div *ngIf="userSessions().length === 0">No previous sessions found.</div>
              <div class="session-list">
                <div *ngFor="let s of userSessions()" class="session-row" (click)="openSession(s.chat_session_id)">
                  <div class="session-title">{{ s.session_title || ('Session ' + s.chat_session_id) }}</div>
                  <div class="session-meta">{{ s.start_time | date:'short' }} ‚Ä¢ {{ s.status }}</div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="cancel-btn" (click)="closeHistory()">Close</button>
            </div>
          </div>
        </div>
<!-- Hidden File Input -->
<input 
  type="file" 
  #fileInput
  (change)="onFileSelected($event)"
  accept=".pdf,.doc,.docx,.xls,.xlsx,.png,.jpg,.jpeg"
  style="display:none"
  multiple
/>
