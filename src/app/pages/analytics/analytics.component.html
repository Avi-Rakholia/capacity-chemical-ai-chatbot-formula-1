<div class="page">

  <!-- MAIN CONTENT -->
  <main class="main">
    <!-- =======================
         STATS ROW
    ======================== -->
    <div class="stats-row">

      <!-- MERGED USER SESSION & TOTAL USERS CARD -->
      <div class="stat-card stat-card--user-session">
        <h3 class="stat-card__title">User Overview</h3>

        <div class="user-session">

          <!-- DONUT CHART -->
          <svg class="user-session__chart" viewBox="0 0 160 160">

            <!-- Background Circle (Light Gray) -->
            <circle 
              cx="80" cy="80" r="70"
              fill="none"
              stroke="#f3f4f6"
              stroke-width="14"
            ></circle>

            <!-- Active Track with Gradient & Shadow (Green) -->
            <circle 
              cx="80" cy="80" r="70"
              fill="none"
              stroke="url(#activeGradient)"
              stroke-width="14"
              [attr.stroke-dasharray]="getCircumference()"
              [attr.stroke-dashoffset]="getCircumference() - (sessionData().active.percentage / 100) * getCircumference()"
              transform="rotate(-90 80 80)"
              stroke-linecap="round"
              class="active-circle"
              filter="url(#glow)"
            ></circle>

            <!-- Inactive Track (Red) - starts where active ends -->
            <circle 
              cx="80" cy="80" r="70"
              fill="none"
              stroke="url(#inactiveGradient)"
              stroke-width="14"
              [attr.stroke-dasharray]="(sessionData().inactive.percentage / 100) * getCircumference() + ' ' + getCircumference()"
              [attr.transform]="'rotate(' + (360 * sessionData().active.percentage / 100 - 90) + ' 80 80)'"
              stroke-linecap="round"
              class="inactive-circle"
            ></circle>

            <!-- Animated Pulse Ring -->
            <circle 
              cx="80" cy="80" r="70"
              fill="none"
              stroke="url(#activeGradient)"
              stroke-width="2"
              opacity="0"
              class="pulse-ring"
            ></circle>

            <!-- Inner Shadow Circle -->
            <circle 
              cx="80" cy="80" r="58"
              fill="white"
              filter="url(#innerShadow)"
            ></circle>

            <!-- Center Icon with Animation -->
            <g class="center-icon">
              <image 
                href="/assets/group.svg"
                x="50"
                y="50"
                height="60"
                width="60"
              />
            </g>

            <!-- Center Text - Count with Animation -->
            <text 
              x="80" 
              y="125" 
              text-anchor="middle" 
              font-size="32" 
              font-weight="800" 
              fill="url(#textGradient)"
              class="center-count"
            >
              {{ totalUsers() }}
            </text>

            <!-- Decorative Dots on Active Arc -->
            <circle 
              cx="80" cy="10" 
              r="4" 
              fill="#10b981"
              class="arc-dot arc-dot-start"
            >
              <animateTransform
                attributeName="transform"
                type="rotate"
                from="0 80 80"
                [attr.to]="(360 * sessionData().active.percentage / 100) + ' 80 80'"
                dur="3s"
                repeatCount="indefinite"
              />
            </circle>

            <defs>
              <!-- Active Gradient (Green) -->
              <linearGradient id="activeGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#34d399;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#10b981;stop-opacity:1" />
              </linearGradient>

              <!-- Inactive Gradient (Red) -->
              <linearGradient id="inactiveGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                <stop offset="50%" style="stop-color:#f87171;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#ef4444;stop-opacity:1" />
              </linearGradient>

              <!-- Text Gradient -->
              <linearGradient id="textGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                <stop offset="0%" style="stop-color:#1f2937;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#4b5563;stop-opacity:1" />
              </linearGradient>

              <!-- Glow Effect -->
              <filter id="glow">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>

              <!-- Inner Shadow -->
              <filter id="innerShadow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                <feOffset dx="0" dy="2" result="offsetblur"/>
                <feComponentTransfer>
                  <feFuncA type="linear" slope="0.2"/>
                </feComponentTransfer>
                <feMerge>
                  <feMergeNode/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>

          </svg>

          <!-- LEGEND -->
          <div class="user-session__legend">

            <div class="legend-item">
              <div class="legend-item-left">
                <span class="legend-dot legend-dot--green"></span>
                <span class="legend-label">Active</span>
              </div>
              <span class="legend-value">{{ sessionData().active.count }} ({{ sessionData().active.percentage }}%)</span>
            </div>

            <div class="legend-item">
              <div class="legend-item-left">
                <span class="legend-dot legend-dot--red"></span>
                <span class="legend-label">Inactive</span>
              </div>
              <span class="legend-value">{{ sessionData().inactive.count }} ({{ sessionData().inactive.percentage }}%)</span>
            </div>

            <div class="legend-item legend-item--total">
              <div class="legend-item-left">
                <span class="legend-dot legend-dot--blue"></span>
                <span class="legend-label">Total</span>
              </div>
              <span class="legend-value">{{ totalUsers() }} users</span>
            </div>

          </div>

        </div>
      </div>

      <!-- =======================
           KPI CARDS (NOW ONLY 2)
      ======================== -->
      <div class="kpi-grid">

        <!-- TOTAL INTERACTION -->
        <div class="stat-card">
          <div class="stat-card__header">
            <img class="stat-card__icon-img" src="/assets/interactivity.svg" alt="" />
            <span class="stat-card__label">Total Interaction</span>
          </div>
          <div class="stat-card__value">
            {{ totalInteractions.value }}
            <span
              class="stat-card__change"
              [ngClass]="{
                'stat-card__change--up': totalInteractions.trend === 'up',
                'stat-card__change--down': totalInteractions.trend === 'down',
                'stat-card__change--neutral': totalInteractions.trend === 'neutral'
              }"
            >
              <ng-container *ngIf="totalInteractions.trend !== 'neutral'; else neutralTI">
                {{ totalInteractions.trend === 'up' ? '+' : '-' }}{{ totalInteractions.change }}%
              </ng-container>
              <ng-template #neutralTI>0%</ng-template>
            </span>

          </div>
          <div class="stat-card__chart">
            <canvas #interactionChart></canvas>
          </div>
        </div>

        <!-- AVG MESSAGES -->
        <div class="stat-card">
          <div class="stat-card__header">
            <img class="stat-card__icon-img" src="/assets/chat.svg" alt="" />
            <span class="stat-card__label">Avg Message/Chat</span>
          </div>
          <div class="stat-card__value">
            {{ avgMessagesPerChat.value }}
           <span
              class="stat-card__change"
              [ngClass]="{
                'stat-card__change--up': avgMessagesPerChat.trend === 'up',
                'stat-card__change--down': avgMessagesPerChat.trend === 'down'
              }"
            >
              {{ avgMessagesPerChat.trend === 'up' ? '+' : '-' }}{{ avgMessagesPerChat.change }}%
            </span>
          </div>
          <div class="stat-card__chart">
            <canvas #messageChart></canvas>
          </div>
        </div>

      </div>
    </div>

    <!-- =======================
         CONTENT ROW
    ======================== -->
    <div class="content-row">

      <!-- QUICK ACCESS -->
      <div class="quick-access-card">
        <h3 class="card-title">Quick Access</h3>

        <div class="quick-access-grid">
          <button class="quick-access-item" *ngFor="let item of quickAccessItems">
            <img class="quick-access-icon" [src]="item.icon" alt="" />
            <span class="quick-access-label">{{ item.label }}</span>
          </button>
        </div>
      </div>

      <!-- CHART CARD -->
      <div class="chart-card">

        <div class="chart-header">
          <h3 class="card-title">Queries over time</h3>

          <select class="year-select" [(ngModel)]="selectedYear" (change)="onYearChange(selectedYear)">
            <option *ngFor="let y of years" [value]="y">{{ y }}</option>
          </select>
        </div>

        <div class="chart-container">
          <canvas #chartCanvas></canvas>
        </div>

        <div class="chart-toggles">
          <button class="download-btn" (click)="downloadChart()">Download PNG</button>
        </div>

      </div>

    </div>


  </main>

</div>