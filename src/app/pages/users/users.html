<div class="users-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <h1 class="page-title">User Management</h1>
      <p class="page-description">Manage users, roles, and permissions</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
      Add New User
    </button>
  </div>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-error">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="12" y1="8" x2="12" y2="12"></line>
        <line x1="12" y1="16" x2="12.01" y2="16"></line>
      </svg>
      <span>{{ error() }}</span>
      <button class="btn-close" (click)="error.set(null)">×</button>
    </div>
  }

  <!-- Filters Section -->
  <div class="filters-section">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input 
        type="text" 
        placeholder="Search users by name, email, or role..." 
        [value]="searchQuery()"
        (input)="searchQuery.set($any($event.target).value)"
        class="search-input"
      />
    </div>
    
    <div class="filter-group">
      <select 
        class="filter-select"
        [value]="statusFilter()"
        (change)="statusFilter.set($any($event.target).value); onFilterChange()"
      >
        <option value="">All Status</option>
        <option value="Active">Active</option>
        <option value="Inactive">Inactive</option>
      </select>

      <select 
        class="filter-select"
        [value]="pageSize()"
        (change)="onPageSizeChange(+$any($event.target).value)"
      >
        <option [value]="5">5 per page</option>
        <option [value]="10">10 per page</option>
        <option [value]="25">25 per page</option>
        <option [value]="50">50 per page</option>
      </select>
    </div>
  </div>

  <!-- Users Table -->
  <div class="table-container">
    @if (loading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading users...</p>
      </div>
    } @else if (filteredUsers().length === 0) {
      <div class="empty-state">
        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
          <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
          <circle cx="9" cy="7" r="4"></circle>
          <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
        </svg>
        <h3>No users found</h3>
        <p>{{ searchQuery() ? 'Try adjusting your search criteria' : 'Get started by adding your first user' }}</p>
        @if (!searchQuery()) {
          <button class="btn btn-primary" (click)="openCreateModal()">Add New User</button>
        }
      </div>
    } @else {
      <table class="users-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Status</th>
            <th>Last Login</th>
            <th class="text-right">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (user of filteredUsers(); track user.user_id) {
            <tr>
              <td>
                <div class="user-cell">
                  <div class="user-avatar">
                    {{ user.name.charAt(0).toUpperCase() }}
                  </div>
                  <span class="user-name">{{ user.name }}</span>
                </div>
              </td>
              <td class="email-cell">{{ user.email }}</td>
              <td>
                <span class="role-badge" [class]="getRoleClass(user.role_name)">
                  {{ user.role_name }}
                </span>
              </td>
              <td>
                <span class="status-badge" [class]="getStatusClass(user.status)">
                  {{ user.status }}
                </span>
              </td>
              <td class="date-cell">
                {{ user.last_login ? (user.last_login | date:'MMM d, y, h:mm a') : 'Never' }}
              </td>
              <td class="actions-cell">
                <div class="action-buttons">
                  <button 
                    class="btn-icon btn-edit" 
                    (click)="openEditModal(user)"
                    title="Edit user"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                      <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                  </button>
                  <button 
                    class="btn-icon btn-delete" 
                    (click)="openDeleteModal(user)"
                    title="Delete user"
                  >
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>

      <!-- Pagination -->
      @if (totalPages() > 1) {
        <div class="pagination">
          <div class="pagination-info">
            Showing {{ (currentPage() - 1) * pageSize() + 1 }} to {{ Math.min(currentPage() * pageSize(), totalItems()) }} of {{ totalItems() }} users
          </div>
          <div class="pagination-controls">
            <button 
              class="btn-pagination" 
              [disabled]="currentPage() === 1"
              (click)="onPageChange(currentPage() - 1)"
            >
              Previous
            </button>
            
            @for (page of pages; track page) {
              @if (page === 1 || page === totalPages() || (page >= currentPage() - 1 && page <= currentPage() + 1)) {
                <button 
                  class="btn-pagination" 
                  [class.active]="page === currentPage()"
                  (click)="onPageChange(page)"
                >
                  {{ page }}
                </button>
              } @else if (page === currentPage() - 2 || page === currentPage() + 2) {
                <span class="pagination-ellipsis">...</span>
              }
            }
            
            <button 
              class="btn-pagination" 
              [disabled]="currentPage() === totalPages()"
              (click)="onPageChange(currentPage() + 1)"
            >
              Next
            </button>
          </div>
        </div>
      }
    }
  </div>
</div>

<!-- Create User Modal -->
@if (showCreateModal()) {
  <div class="modal-overlay" (click)="closeCreateModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Add New User</h2>
        <button class="btn-close" (click)="closeCreateModal()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="createUser()">
          <div class="form-group">
            <label for="create-name">Full Name *</label>
            <input 
              type="text" 
              id="create-name" 
              class="form-input"
              [(ngModel)]="createForm().name"
              name="name"
              required
              placeholder="Enter full name"
            />
          </div>

          <div class="form-group">
            <label for="create-email">Email *</label>
            <input 
              type="email" 
              id="create-email" 
              class="form-input"
              [(ngModel)]="createForm().email"
              name="email"
              required
              placeholder="user@example.com"
            />
          </div>

          <div class="form-group">
            <label for="create-password">Password *</label>
            <input 
              type="password" 
              id="create-password" 
              class="form-input"
              [(ngModel)]="createForm().password"
              name="password"
              required
              placeholder="Enter password"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="create-role">Role *</label>
              <select 
                id="create-role" 
                class="form-select"
                [(ngModel)]="createForm().role_id"
                name="role_id"
                required
              >
                <option [value]="1">Admin</option>
                <option [value]="2">Supervisor</option>
                <option [value]="3">Chemist</option>
                <option [value]="4">Sales</option>
                <option [value]="5">Worker</option>
              </select>
            </div>

            <div class="form-group">
              <label for="create-status">Status *</label>
              <select 
                id="create-status" 
                class="form-select"
                [(ngModel)]="createForm().status"
                name="status"
                required
              >
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading()">
              {{ loading() ? 'Creating...' : 'Create User' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

<!-- Edit User Modal -->
@if (showEditModal() && selectedUser()) {
  <div class="modal-overlay" (click)="closeEditModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Edit User</h2>
        <button class="btn-close" (click)="closeEditModal()">×</button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="updateUser()">
          <div class="form-group">
            <label for="edit-name">Full Name</label>
            <input 
              type="text" 
              id="edit-name" 
              class="form-input"
              [(ngModel)]="editForm().name"
              name="name"
              placeholder="Enter full name"
            />
          </div>

          <div class="form-group">
            <label for="edit-email">Email</label>
            <input 
              type="email" 
              id="edit-email" 
              class="form-input"
              [(ngModel)]="editForm().email"
              name="email"
              placeholder="user@example.com"
            />
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="edit-role">Role</label>
              <select 
                id="edit-role" 
                class="form-select"
                [(ngModel)]="editForm().role_id"
                name="role_id"
              >
                <option [value]="1">Admin</option>
                <option [value]="2">Supervisor</option>
                <option [value]="3">Chemist</option>
                <option [value]="4">Sales</option>
                <option [value]="5">Worker</option>
              </select>
            </div>

            <div class="form-group">
              <label for="edit-status">Status</label>
              <select 
                id="edit-status" 
                class="form-select"
                [(ngModel)]="editForm().status"
                name="status"
              >
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading()">
              {{ loading() ? 'Updating...' : 'Update User' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal() && selectedUser()) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal modal-sm" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Delete User</h2>
        <button class="btn-close" (click)="closeDeleteModal()">×</button>
      </div>
      <div class="modal-body">
        <p class="delete-message">
          Are you sure you want to delete <strong>{{ selectedUser()?.name }}</strong>?
          This action cannot be undone.
        </p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">
            Cancel
          </button>
          <button type="button" class="btn btn-danger" (click)="deleteUser()" [disabled]="loading()">
            {{ loading() ? 'Deleting...' : 'Delete User' }}
          </button>
        </div>
      </div>
    </div>
  </div>
}
